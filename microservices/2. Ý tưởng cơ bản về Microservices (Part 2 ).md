Credit: NekoArcoder - [https://viblo.asia/u/trandatk](https://viblo.asia/u/trandatk)

# II. Kho lÆ°Æ¡ng cá»§a kiáº¿n trÃºc Microservices (Data in microservices)

Khi chÃºng ta Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c hÃ²m hÃ²m **Microservices** lÃ  gÃ¬ thÃ¬ gáº·p ngay má»™t con boss khÃ³ nháº±n trong hÃ nh trÃ¬nh tÃ¬m hiá»ƒu, báº¡n cÃ³ thá»ƒ Ä‘oÃ¡n ra khÃ´ng?

Thá»­ quay láº¡i má»™t chÃºt nhÃ©, khi nhÃ¬n vÃ o láº¡i sÆ¡ Ä‘á»“ nÃ y vÃ  mÃ¬nh sáº½ gá»£i Ã½ má»™t chÃºt:

![image.png](https://images.viblo.asia/541c998e-310c-4259-b840-1f703222150e.png)

Yes, Ä‘Ãºng váº­y. CÃ´ng nghá»‡ á»Ÿ má»—i feature cÃ³ thá»ƒ khÃ¡c nhau, logic nghiá»‡p vá»¥ cÃ³ thá»ƒ khÃ¡c nhau, nhÆ°ng database cÅ©ng pháº£i khÃ¡c nhau ná»‘t luÃ´n?

Báº¡n nháº­n ra sá»± nghiÃªm trá»ng cá»§a nÃ³ chá»©? Khi thiáº¿t káº¿ cÆ¡ sá»Ÿ dá»¯ liá»‡u quan há»‡ (**SQL**), báº¡n cáº§n Ä‘áº£m báº£o cÃ¡c má»‘i quan há»‡ giá»¯a cÃ¡c báº£ng Ä‘Æ°á»£c thá»ƒ hiá»‡n má»™t cÃ¡ch cháº·t cháº½ thÃ´ng qua viá»‡c sá»­ dá»¥ng cÃ¡c *khÃ³a ngoáº¡i (foreign keys)*.

Tháº¿ cÃ²n bÃ¢y giá», á»Ÿ trong kiáº¿n trÃºc **Microservices**, á»Ÿ má»—i service láº¡i cÃ³ má»™t database riÃªng (Náº¿u cáº§n) Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c tráº¡ng thÃ¡i cÃ´ láº­p tuyá»‡t Ä‘á»‘i, khÃ´ng phá»¥ thuá»™c vÃ o nhau, nhÆ° váº­y thÃ¬ chÃºng ta pháº£i lÃ m tháº¿ nÃ o?

**Váº­y chÃºng ta Ä‘ang cÃ³ á»Ÿ Ä‘Ã¢y lÃ  2 váº¥n Ä‘á» cáº§n pháº£i náº¯m rÃµ khi "**Quáº£n lÃ½ dá»¯ liá»‡u giá»¯a cÃ¡c service**":**

1. CÃ¡ch chÃºng ta lÆ°u trá»¯ dá»¯ liá»‡u bÃªn trong má»™t service sáº½ nhÆ° tháº¿ nÃ o?
2. CÃ¡ch chÃºng ta giao tiáº¿p, chia sáº» dá»¯ liá»‡u giá»¯a cÃ¡c service khÃ¡c nhau sáº½ ra sao?

ÄÃ¢y lÃ  má»™t váº¥n Ä‘á» lá»›n, ráº¥t khÃ³, vÃ  lÃ  rÃ o cáº£n chÃ­nh khi triá»ƒn khai **microservices** hiá»‡u quáº£. Báº¡n sáº½ cáº£m tháº¥y nÃ³ khÃ³ vÃ¬ trong kiáº¿n trÃºc **microservices**, cÃ¡ch lÆ°u trá»¯ vÃ  truy cáº­p dá»¯ liá»‡u khÃ¡c so vá»›i cÃ¡ch báº¡n tá»«ng quen trong á»©ng dá»¥ng **monolithic**.

NhÆ°ng khÃ´ng sao, Ä‘Ã£ cÃ³ tÃ´i á»Ÿ Ä‘Ã¢y vá»›i báº¡n, chÃºng ta cá»© tiáº¿p tá»¥c tá»« tá»« tÃ¬m hiá»ƒu nÃ o!

## 1. CÃ¡ch lÆ°u trá»¯ dá»¯ liá»‡u trong microservices

NhÆ° mÃ¬nh Ä‘Ã£ trÃ¬nh bÃ y, má»—i service cÃ³ cÆ¡ sá»Ÿ dá»¯ liá»‡u riÃªng biá»‡t vÃ  khÃ´ng phá»¥ thuá»™c vÃ o nhau. Ta cÅ©ng cÃ³ thá»ƒ phÃ¡t biá»ƒu nhÆ° sau:

> Vá»›i **microservices**, má»—i service sáº½ cÃ³ **database riÃªng** cá»§a nÃ³, náº¿u nÃ³ cáº§n lÆ°u trá»¯ dá»¯ liá»‡u.

- Náº¿u má»™t service khÃ´ng cáº§n dá»¯ liá»‡u, thÃ¬ khÃ´ng cáº§n cáº¥p database cho nÃ³.
- NhÆ°ng náº¿u cáº§n, khÃ´ng cÃ³ chuyá»‡n dÃ¹ng chung database. Má»—i service sáº½ cÃ³ database Ä‘á»™c láº­p.

![image.png](https://images.viblo.asia/bd52cb74-e8b9-4728-9f70-175d74123e4a.png)

KhÃ´ng Ä‘Æ°á»£c xÃ i chung nhÆ° tháº¿ nÃ y nhÃ©, má»—i nhÃ  má»™t chá»“ng má»™t vá»£, chá»© khÃ´ng cÃ³ chuyá»‡n lÃ©ng phÃ©ng sang nhÃ  hÃ ng xÃ³m nhÃ© ğŸ˜‚

## 2. CÃ¡ch truy cáº­p dá»¯ liá»‡u (vÃ  Ä‘iá»u chÃºng ta khÃ´ng nÃªn lÃ m)

> **KhÃ´ng bao giá»** má»™t service nÃ y Ä‘Æ°á»£c phÃ©p truy cáº­p trá»±c tiáº¿p vÃ o database cá»§a service khÃ¡c.

Chá»‰ Ä‘Æ¡n giáº£n tháº¿ thÃ´i, vÃ­ dá»¥ nhÃ©: Service A khÃ´ng bao giá» Ä‘Æ°á»£c phÃ©p â€œchá»câ€ vÃ o database cá»§a Service B, trong báº¥t ká»³ tÃ¬nh huá»‘ng nÃ o. DÃ¹ lÃ  chá»‹ Database B cÃ³ káº¹t trong mÃ¡y giáº·t hay nhá» báº¡n qua sá»­a á»‘ng nÆ°á»›c Ä‘i chÄƒng ná»¯a cÅ©ng KHÃ”NG Ä‘Æ°á»£c nhÃ© =))).

![image.png](https://images.viblo.asia/056c1cec-1660-4b96-8c27-60aab9195b5e.png)

**TÃºm cÃ¡i vÃ¡y láº¡i, chá»‰ cáº§n báº¡n nhá»› 2 thá»©:**

**1. Má»—i service cÃ³ database riÃªng cá»§a nÃ³ (náº¿u cáº§n).**

**2. Má»™t service khÃ´ng bao giá» truy cáº­p database cá»§a service khÃ¡c.**

## 3. Táº¡i sao tÃ´i pháº£i lÃ m nhÆ° váº­y?

ÄÃºng váº­y, chá»‰ Nam chá»‰ Báº¯c mÃ  cháº£ nÃ³i táº¡i sao thÃ¬ sao mÃ  hiá»ƒu Ä‘Æ°á»£c Ä‘Ãºng khÃ´ng, thá»±c ra cÃ³ táº§m 4 lÃ½ do mÃ  mÃ¬nh cÃ³ thá»ƒ nghÄ© ra cho Ä‘iá»u nÃ y.

#### Má»—i service nÃªn hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p

Pattern nÃ y cÃ³ tÃªn chÃ­nh thá»©c lÃ  â€œ**Database per service**â€, tá»©c lÃ  má»—i service cÃ³ database riÃªng.

Giáº£ sá»­ báº¡n cÃ³ táº¥t cáº£ service cÃ¹ng dÃ¹ng chung má»™t database. Náº¿u database Ä‘Ã³ gáº·p trá»¥c tráº·c, toÃ n bá»™ há»‡ thá»‘ng sáº½ sáº­p.

![image.png](https://images.viblo.asia/318582b4-8f1a-4082-a9f3-863345825484.png)KhÃ´ng chá»‰ váº­y, viá»‡c scale (má»Ÿ rá»™ng) database chung nÃ y sáº½ ráº¥t khÃ³ khÄƒn.

Báº¡n sáº½ pháº£i scale má»™t database duy nháº¥t Ä‘á»ƒ phá»¥c vá»¥ má»i service, thay vÃ¬ chá»‰ scale nhá»¯ng pháº§n thá»±c sá»± cáº§n.

#### TrÃ¡nh phá»¥ thuá»™c chÃ©o giá»¯a cÃ¡c service

Láº¥y vÃ­ dá»¥ nhÃ©:

Náº¿u Service A truy cáº­p database cá»§a Service B, vÃ  database B bá»‹ lá»—i, thÃ¬ Service A cÅ©ng sáº½ sáº­p theo.

Äiá»u nÃ y táº¡o ra sá»± phá»¥ thuá»™c chÃ©o nguy hiá»ƒm, khiáº¿n má»™t lá»—i nhá» cÃ³ thá»ƒ lan rá»™ng toÃ n há»‡ thá»‘ng.

![image.png](https://images.viblo.asia/004c41d0-cb8a-472d-a9ce-64751a59b344.png)

#### TrÃ¡nh lá»—i do thay Ä‘á»•i schema

ChÃºng ta sáº½ nháº­p vai lÃ  Dev cho má»™t cÃ´ng ty thuá»™c ngÃ nh cÃ´ng nghiá»‡p khÃ´ng khÃ³i cá»§a Nháº­t Ä‘á»ƒ cho dá»… hiá»ƒu nhÃ© =)))))

- Giáº£ sá»­ Service CODE gá»i trá»±c tiáº¿p database cá»§a Service ACTOR Ä‘á»ƒ láº¥y thÃ´ng tin cá»§a diá»…n viÃªn.
- Ban Ä‘áº§u, dá»¯ liá»‡u tráº£ vá» cÃ³ dáº¡ng {"name": "Himari"}.
- Rá»“i team Service ACTOR quyáº¿t Ä‘á»‹nh Ä‘á»•i "name" thÃ nh "url" mÃ  khÃ´ng thÃ´ng bÃ¡o.
- Láº§n tá»›i Service CODE gá»i, nÃ³ nháº­n key "url", mÃ  láº¡i Ä‘ang mong Ä‘á»£i "name", tháº¿ lÃ  lá»—i xáº£y ra.

![image.png](https://images.viblo.asia/bc8dd019-3636-4ade-8742-387754dc65b1.png)

Lá»—i nÃ y ráº¥t khÃ³ debug, vÃ¬ nÃ³ khÃ´ng Ä‘áº¿n tá»« service Actor hay service Code, cÅ©ng khÃ´ng pháº£i lá»—i há»‡ thá»‘ng... mÃ  lÃ  do sá»± thay Ä‘á»•i khÃ´ng Ä‘Æ°á»£c Ä‘á»“ng bá»™ giá»¯a cÃ¡c team.

#### Tá»‘i Æ°u hiá»‡u nÄƒng báº±ng database chuyÃªn biá»‡t

Má»™t sá»‘ service cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng hiá»‡u quáº£ hÆ¡n khi dÃ¹ng loáº¡i database khÃ¡c.

VÃ­ dá»¥:

- CÃ³ service nÃªn dÃ¹ng MongoDB thay vÃ¬ PostgreSQL.
- Hoáº·c Redis thay vÃ¬ MySQL.

Khi dÃ¹ng â€œ**database per service**â€, báº¡n cÃ³ quyá»n chá»n loáº¡i database phÃ¹ há»£p nháº¥t cho tá»«ng service.

## 4. Tháº¿ ngoÃ i kia há» Ä‘ang lÃ m tháº¿ nÃ o?

Báº¡n cÃ³ thá»ƒ Ä‘ang tháº¯c máº¯c lÃ  thá»±c táº¿ ngoÃ i kia há» cÃ³ lÃ m nhÆ° váº­y hay khÃ´ng, chÃºng ta cÃ³ thá»±c sá»± pháº£i Ã¡p dá»¥ng pattern nÃ y khÃ´ng?

ThÃ¬ cÃ¢u tráº£ lá»i cá»§a mÃ¬nh lÃ  cÃ³ vÃ  há» Ä‘ang thá»±c sá»± Ã¡p dá»¥ng, mÃ¬nh xin trÃ­ch láº¡i cÃ¢u cá»§a anh Stephen Grider nhÆ° sau:

> *Táº¥t cáº£ cÃ¡c Ä‘á»™i ká»¹ thuáº­t giá»i Ä‘ang triá»ƒn khai microservices Ä‘á»u Ã¡p dá»¥ng Ä‘Ãºng pattern nÃ y â€“ má»—i service má»™t database.*

Xem ra chÃºng ta Ä‘Ã£ Ä‘i Ä‘Ãºng hÆ°á»›ng rá»“i, nhÆ°ng náº¿u váº¥n Ä‘á» chá»‰ Ä‘Æ¡n giáº£n tháº¿ thÃ¬ lÃ m sao gá»i lÃ  má»™t **Big problem** Ä‘Ãºng khÃ´ng =))))